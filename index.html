<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bertik v25 (Eyes Fine-Tuning)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/rest";
        window.Octokit = Octokit;
    </script>
    
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Montserrat', sans-serif; overflow: hidden; user-select: none; }

        /* --- 1. VIDEA --- */
        .video-layer { 
            position: fixed; inset: 0; width: 100%; height: 100%;
            z-index: 1; background: #000; object-fit: cover; 
        }
        .hidden { opacity: 0; pointer-events: none; }
        .visible { opacity: 1; pointer-events: auto; }

        #liveVideo { transform: scaleX(-1); }
        
        #thumbPreview { 
            display: none; position: fixed; inset: 0; width: 100%; height: 100%; 
            object-fit: contain; background: #000; z-index: 90; 
        }

        /* --- 2. AVATAR --- */
        .center-stage { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 85vh; height: 85vh; pointer-events: none; z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
        .char-part { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; }
        
        #headSleep { z-index: 20; display: block; }
        #headBase { z-index: 12; opacity: 0; transition: opacity 0.1s; }
        #eyesCanvas { z-index: 15; opacity: 0; transition: opacity 0.1s; }
        #layerBlink { z-index: 25; opacity: 0; }
        #layerTongue { z-index: 30; opacity: 0; }
        #layerEars { z-index: 11; opacity: 0; }

        .source-video-hidden { position: fixed; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: -1; }

        /* --- 3. UI --- */
        #uiLayer { position: fixed; inset: 0; z-index: 100; pointer-events: none; }
        .interactive { pointer-events: auto; cursor: pointer; }

        .top-right { position: absolute; top: 30px; right: 30px; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; text-shadow: 2px 2px 4px #000; }
        #settingsIcon { cursor: pointer; opacity: 0.8; margin-bottom: 10px; font-size: 24px; }
        #statsMenu { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; height: 0; overflow: hidden; opacity: 0; transition: all 0.5s ease; background: rgba(0,0,0,0.5); padding: 0 10px; border-radius: 8px; }
        #statsMenu.visible { height: auto; opacity: 1; padding: 10px; }
        .stat-row { display: flex; align-items: center; justify-content: flex-end; gap: 10px; font-size: 12px; color: #ccc; }
        .bar-bg { width: 60px; height: 4px; background: #444; border-radius: 2px; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.5s; }
        .color-dot { width: 10px; height: 10px; background: #000; border-radius: 50%; }
        .toggle-btn { background: transparent; border: 1px solid #aaa; color: #fff; padding: 2px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; }

        .bottom-left { 
            position: absolute; bottom: 30px; left: 30px; right: 30px; 
            display: flex; flex-direction: column; gap: 20px; 
        }
        
        .buttons-row { display: flex; gap: 30px; align-items: flex-end; }
        
        .big-btn { 
            width: 140px; height: 140px; 
            background-size: contain; background-repeat: no-repeat; background-position: center; 
            background-color: transparent; border: none; cursor: pointer; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.8)); transition: transform 0.1s; 
            position: relative; z-index: 2;
        }
        .big-btn:active { transform: scale(0.95); filter: brightness(0.8); }

        .power-wrapper { position: relative; }
        #powerGlow {
            position: absolute; top: 50%; left: 50%;
            width: 250px; height: 250px;
            background: radial-gradient(circle, rgba(255,0,0,0.8) 0%, rgba(255,0,0,0) 70%);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 1;
            animation: pulseRed 2s infinite ease-in-out;
            display: none;
        }
        @keyframes pulseRed {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.2; }
            50% { transform: translate(-50%, -50%) scale(1.4); opacity: 0.6; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.2; }
        }

        .slider-wrapper { width: 100%; height: 30px; display: flex; align-items: center; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; background: #fff; border-radius: 50%; margin-top: -10px; box-shadow: 0 0 10px rgba(0,0,0,0.8); }

        #uploadInd { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 11px; display: none; z-index: 200; background: orange; color: black; padding: 4px 12px; border-radius: 20px; font-weight: bold; }
        #cacheStatus { font-size: 10px; color: #555; margin-top: 5px; }

        #introLayer { position: fixed; inset: 0; background: #000; z-index: 5000; padding: 40px; display: flex; flex-direction: column; }
        #introLayer.hidden { display: none; }
        .intro-top { display: flex; justify-content: space-between; width: 100%; }
        .intro-title h1 { margin: 0; font-size: 16px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }
        .intro-desc { width: 300px; font-size: 13px; color: #aaa; margin-top: 20px; line-height: 1.5; }
        .intro-opts { text-align: right; display: flex; flex-direction: column; gap: 10px; }
        .opt-row select { background: transparent; border: none; color: #fff; font-family: inherit; text-align: right; cursor: pointer; }
        #startBtn { position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); background: transparent; border: none; color: #fff; font-size: 16px; font-weight: 700; letter-spacing: 3px; cursor: pointer; padding: 20px; }
        #analysisCanvas { display: none; }
        
        @media (max-width: 600px) {
            .intro-top { flex-direction: column; gap: 30px; }
            .intro-desc { width: 100%; }
            .intro-opts { text-align: left; }
            .center-stage { width: 90vw; height: 90vw; }
            .bottom-left { left: 15px; right: 15px; bottom: 20px; gap: 15px; }
            .buttons-row { width: 100%; justify-content: space-between; gap: 0; }
            .big-btn { width: 85px; height: 85px; }
            #powerGlow { width: 150px; height: 150px; }
        }
    </style>
</head>
<body>

    <div id="introLayer">
        <div class="intro-top">
            <div class="intro-title">
                <h1>Online Bertík</h1>
                <div class="intro-desc">Program neustále nahrává a analyzuje své okolí. Podle toho, co vidí a slyší, může vyhledat a přehrát nejpodobnější záznam ze sdílené paměti.</div>
            </div>
            <div class="intro-opts interactive">
                <div class="opt-row">KAMERA <select id="selCam"><option>Načítám...</option></select></div>
                <div class="opt-row">AUDIO <select id="selMic"><option>Načítám...</option></select></div>
            </div>
        </div>
        <button id="startBtn" class="interactive">SPUSTIT</button>
    </div>

    <div id="videoContainer">
        <video id="liveVideo" class="video-layer hidden" autoplay muted playsinline></video>
        <video id="playbackVideo" class="video-layer hidden" playsinline></video>
        <video id="chunkVideo" class="video-layer hidden" playsinline></video>
        <video id="preloadVideo" style="display:none;" muted playsinline></video>
    </div>
    
    <img id="thumbPreview">

    <video id="srcMask" class="source-video-hidden" src="assets/eyes_alpha_channel.webm" loop muted playsinline></video>
    <video id="srcPupils" class="source-video-hidden" src="assets/eyes_zornicky.webm" loop muted playsinline></video>

    <div class="center-stage">
        <img id="headSleep" class="char-part" src="assets/head_sleep.png">
        <video id="layerEars" class="char-part" src="assets/ears_active.webm" loop muted playsinline></video>
        <video id="headBase" class="char-part" src="assets/head_idle.webm" loop muted playsinline></video>
        <canvas id="eyesCanvas" class="char-part" width="2048" height="2048"></canvas>
        <video id="layerBlink" class="char-part" src="" muted playsinline></video>
        <video id="layerTongue" class="char-part" src="" muted playsinline></video>
    </div>

    <div id="uiLayer">
        <div id="uploadInd">NAHRÁVÁM...</div>
        <div class="top-right interactive">
            <div id="settingsIcon">⚙</div>
            <div style="font-weight: 600;" id="timeDisplay">00:00:00</div>
            <div style="font-size: 12px; color:#ccc;" id="dateDisplay">--.--.----</div>
            <div id="statsToggle" style="cursor: pointer; margin-top: 5px;">▼</div>
            <div id="statsMenu">
                <div class="stat-row">ZOBRAZENÍ <button id="fitToggleBtn" class="toggle-btn">VYPLNIT</button></div>
                <div style="height:1px; background:#444; margin:5px 0;"></div>
                <div class="stat-row">HLASITOST <div class="bar-bg"><div id="bVol" class="bar-fill"></div></div></div>
                <div class="stat-row">JAS <div class="bar-bg"><div id="bBri" class="bar-fill"></div></div></div>
                <div class="stat-row">TEPLOTA <div class="bar-bg"><div id="bWarm" class="bar-fill"></div></div></div>
                <div class="stat-row">BARVA <div class="color-dot" id="bCol"></div></div>
                <div id="cacheStatus">CACHE: 0/0</div>
            </div>
        </div>
        
        <div class="bottom-left interactive">
            <div class="buttons-row">
                <button id="btnSim" class="big-btn" style="background-image: url('assets/btn_sim_idle.png')"></button>
                <button id="btnTime" class="big-btn" style="background-image: url('assets/btn_time_off.png')"></button>
                <div class="power-wrapper">
                    <div id="powerGlow"></div>
                    <button id="btnPwr" class="big-btn" style="background-image: url('assets/btn_power_off.png')"></button>
                </div>
            </div>
            
            <div class="slider-wrapper">
                <input type="range" id="slider" min="0" max="100" value="100" disabled>
            </div>
        </div>
    </div>

    <canvas id="analysisCanvas" width="64" height="64" style="display:none"></canvas>

    <script>
        const CAST_1 = "ghp_"; 
        const CAST_2 = "uV9FhsFwrzeKlOVtPnY72bMhVGAHjh4IPNL8"; // <--- !!! TOKEN !!!
        const TOKEN = CAST_1 + CAST_2;
        const REPO = { owner: "matyaskunstmuller", name: "bertik" };

        const STATE = { OFF: 0, LIVE: 1, PLAY: 2, TIME: 3 };
        let state = STATE.OFF;
        
        let octokit, mediaRecorder, chunks = [];
        let memories = [];
        let recInterval, analysisInterval;
        let camId, micId;
        let isCover = true; 
        let isTongueActive = false;

        const chunkCache = new Map();
        let totalChunks = 0;
        const CHUNK_SIZE = 300; 

        let mouseX=window.innerWidth/2, mouseY=window.innerHeight/2;
        let pupilX=0, pupilY=0, lastEyeUpdate=0, lastMouseMoveTime=Date.now();
        let roamX=0, roamY=0, roamTargetTime=0;

        const el = {
            live: document.getElementById('liveVideo'),
            play: document.getElementById('playbackVideo'),
            chunk: document.getElementById('chunkVideo'),
            preload: document.getElementById('preloadVideo'),
            thumb: document.getElementById('thumbPreview'),
            slider: document.getElementById('slider'),
            statsMenu: document.getElementById('statsMenu'),
            fitBtn: document.getElementById('fitToggleBtn'),
            cacheTxt: document.getElementById('cacheStatus'),
            headS: document.getElementById('headSleep'),
            headB: document.getElementById('headBase'),
            eyes: document.getElementById('eyesCanvas'),
            ears: document.getElementById('layerEars'),
            blink: document.getElementById('layerBlink'),
            tongue: document.getElementById('layerTongue'),
            btnPwr: document.getElementById('btnPwr'),
            btnTime: document.getElementById('btnTime'),
            btnSim: document.getElementById('btnSim'),
            glow: document.getElementById('powerGlow')
        };
        const ctxEyes = el.eyes.getContext('2d');
        const srcMask = document.getElementById('srcMask');
        const srcPupils = document.getElementById('srcPupils');
        const ctxAn = document.getElementById('analysisCanvas').getContext('2d');
        let stats = { bri:0, vol:0 };
        let analyser, dataArray;

        document.addEventListener("DOMContentLoaded", () => {
            if(window.Octokit) octokit = new window.Octokit({ auth: TOKEN });
            loadDevices();
            setInterval(updateClock, 1000);
            renderAvatarLoop();
            el.glow.style.display = 'block';
        });

        document.getElementById('startBtn').addEventListener('click', async () => {
            camId = document.getElementById('selCam').value;
            micId = document.getElementById('selMic').value;
            srcMask.play(); srcPupils.play(); 
            await loadDB();
            downloadAllChunks();
            el.slider.value = el.slider.max; 
            document.getElementById('introLayer').classList.add('hidden');
        });

        document.getElementById('settingsIcon').addEventListener('click', () => { document.getElementById('introLayer').classList.remove('hidden'); });
        document.getElementById('statsToggle').addEventListener('click', () => { el.statsMenu.classList.toggle('visible'); });
        
        el.fitBtn.addEventListener('click', () => {
            isCover = !isCover;
            const mode = isCover ? 'cover' : 'contain';
            el.fitBtn.innerText = isCover ? 'VYPLNIT' : 'CELÉ';
            document.querySelectorAll('.video-layer').forEach(v => v.style.objectFit = mode);
        });

        el.btnPwr.addEventListener('click', () => {
            if (state === STATE.OFF) setState(STATE.LIVE);
            else setState(STATE.OFF);
        });

        el.btnTime.addEventListener('click', () => {
            if (state === STATE.OFF) return;
            if (state === STATE.TIME) stopTimelapseAndShow(); 
            else setState(STATE.TIME);
        });

        el.btnSim.addEventListener('click', () => {
            if (state !== STATE.OFF) findSimilar();
        });

        async function setState(mode) {
            state = mode;
            
            const show = (e) => { e.classList.remove('hidden'); e.classList.add('visible'); };
            const hide = (e) => { e.classList.remove('visible'); e.classList.add('hidden'); };

            hide(el.live); hide(el.play); hide(el.chunk);
            el.thumb.style.display = 'none';
            el.play.pause(); el.chunk.pause();

            el.btnPwr.style.backgroundImage = (mode===STATE.OFF) ? "url('assets/btn_power_off.png')" : "url('assets/btn_power_on.png')";
            el.btnTime.style.backgroundImage = (mode===STATE.TIME) ? "url('assets/btn_time_on.png')" : "url('assets/btn_time_off.png')";
            el.glow.style.display = (mode === STATE.OFF) ? 'block' : 'none';

            if (mode === STATE.OFF) {
                stopRec(); stopAnalysis();
                el.headS.style.display = 'block';
                el.headB.style.opacity=0; el.eyes.style.opacity=0; el.ears.style.opacity=0;
                el.slider.disabled = true;
                if(el.live.srcObject) el.live.srcObject.getTracks().forEach(t=>t.stop());

            } else if (mode === STATE.LIVE) {
                await initCam();
                startRec(); startAnalysis();
                show(el.live);
                el.headS.style.display = 'none';
                el.headB.style.opacity=1; el.eyes.style.opacity=1; el.ears.style.opacity=1;
                el.headB.play(); el.ears.play();
                el.slider.disabled = false;
                el.slider.value = memories.length;

            } else if (mode === STATE.PLAY) {
                stopRec();
                show(el.play);
            
            } else if (mode === STATE.TIME) {
                stopRec();
                runTimelapse();
            }
        }

        // --- AVATAR (Final Adjustment) ---
        document.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; lastMouseMoveTime = Date.now(); });

        function renderAvatarLoop() {
            if(state !== STATE.OFF) {
                const now = Date.now();
                if (now - lastEyeUpdate > (1000/12)) {
                    let tx, ty;
                    if (now - lastMouseMoveTime > 3000) {
                        // Roaming (zmenšeno o 2.5x oproti v24)
                        if (now > roamTargetTime) {
                            roamX = (Math.random()-0.5)*90; 
                            roamY = (Math.random()-0.5)*48;
                            roamTargetTime = now + 2000 + Math.random()*500;
                        }
                        tx = pupilX + (roamX - pupilX)*0.2; 
                        ty = pupilY + (roamY - pupilY)*0.2;
                    } else {
                        // Sledování (zvětšeno o 1.5x oproti v24)
                        const cx = window.innerWidth/2; const cy = window.innerHeight/2;
                        tx = ((mouseX-cx)/100)*4.5; 
                        ty = ((mouseY-cy)/100)*4.5;
                    }
                    
                    // Rychlost 0.3
                    pupilX += (tx - pupilX) * 0.3;
                    pupilY += (ty - pupilY) * 0.3;

                    lastEyeUpdate = now;
                }
                
                const W = el.eyes.width; const H = el.eyes.height;
                ctxEyes.clearRect(0,0,W,H); 
                
                if(srcMask.readyState>=2 && (el.headB.style.opacity == 1 || isTongueActive)) {
                    // Alpha Maska
                    ctxEyes.globalCompositeOperation = 'source-over';
                    ctxEyes.drawImage(srcMask,0,0,W,H); 
                    
                    ctxEyes.globalCompositeOperation = 'source-in'; 
                    // Režim screen pro fix černé, pokud je alpha poškozená (pojistka)
                    // Pokud je alpha OK, screen nevadí.
                    // ctxEyes.globalCompositeOperation = 'screen'; // Lze zkusit, pokud je stále problém, ale 'source-in' je správně pro masku
                    
                    ctxEyes.drawImage(srcPupils, 0 + pupilX*5, 0 + pupilY*5, 2048, 2048);
                    
                    ctxEyes.globalCompositeOperation = 'source-over';
                }
            }
            requestAnimationFrame(renderAvatarLoop);
        }

        function triggerBlink() {
            if(state===STATE.OFF) return;
            el.headB.style.opacity=0; el.eyes.style.opacity=0; 
            el.blink.src = "assets/blink_anim.webm"; el.blink.style.opacity=1; el.blink.play();
            el.blink.onended = () => { el.blink.style.opacity=0; el.headB.style.opacity=1; el.eyes.style.opacity=1; };
        }
        function triggerTongue() {
            if(state===STATE.OFF) return;
            isTongueActive = true; 
            el.headB.style.opacity=0; 
            el.tongue.src = "assets/tongue_action.webm"; el.tongue.style.opacity=1; el.tongue.play();
            el.tongue.onended = () => { 
                isTongueActive = false; 
                el.tongue.style.opacity=0; el.headB.style.opacity=1; el.eyes.style.opacity=1; 
            };
        }
        setInterval(() => { if(Math.random()>0.7) triggerBlink(); }, 4000);

        // --- PŘEHRÁVÁNÍ & NÁHLEDY ---
        el.slider.addEventListener('input', () => {
            if(state===STATE.OFF) return;
            if(state!==STATE.PLAY) setState(STATE.PLAY);
            el.play.classList.remove('visible'); el.play.classList.add('hidden');
            el.thumb.style.display='block';
            
            const idx = parseInt(el.slider.value);
            if(idx >= memories.length) {
                el.thumb.style.display='none';
            } else {
                const tIdx = Math.floor(idx/5)*5;
                el.thumb.src = `https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/thumbs/thumb_${tIdx}.jpg?t=${Date.now()}`;
            }
        });

        el.slider.addEventListener('change', () => {
            const idx = parseInt(el.slider.value);
            if(idx >= memories.length) setState(STATE.LIVE);
            else playMem(idx);
        });

        async function playMem(idx) {
            el.thumb.style.display='none';
            el.play.classList.remove('hidden'); el.play.classList.add('visible');
            const mem = memories[idx];
            if(!mem) return;
            el.play.src = `https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/${mem.filename}`;
            try { await el.play.play(); } catch(e){}
        }

        el.play.onended = () => {
            const next = parseInt(el.slider.value)+1;
            if(next < memories.length) { el.slider.value=next; playMem(next); }
            else setState(STATE.LIVE);
        };

        function findSimilar() {
            if(memories.length<5) return;
            let best=0; let min=Infinity;
            memories.forEach((m,i)=>{
                const dbBri = m.stats ? m.stats.brightness : 128;
                const diff = Math.abs(dbBri - stats.bri);
                if(diff<min){min=diff; best=i;}
            });
            if(best===0) best=Math.floor(Math.random()*(memories.length-1));
            el.slider.value=best; playMem(best); triggerTongue();
        }

        // --- ČASOSBĚR ---
        async function downloadAllChunks() {
            totalChunks = Math.ceil(memories.length / CHUNK_SIZE);
            el.cacheTxt.innerText = `CACHE: 0/${totalChunks}`;
            for (let i = 0; i < totalChunks; i++) {
                const url = `https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/chunks/chunk_${i}.webm`;
                try {
                    const r = await fetch(url);
                    if (r.ok) {
                        const blob = await r.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        chunkCache.set(i, blobUrl);
                        el.cacheTxt.innerText = `CACHE: ${i+1}/${totalChunks}`;
                    }
                } catch(e) {}
            }
            el.cacheTxt.innerText = "CACHE: READY";
            el.cacheTxt.style.color = "lime";
        }

        let chunkId = 0;

        async function runTimelapse() {
            chunkId = 0; 
            playNextChunk();
        }

        async function playNextChunk() {
            if(state !== STATE.TIME) return;

            let src = chunkCache.get(chunkId);
            if(!src) src = `https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/chunks/chunk_${chunkId}.webm`;
            
            el.chunk.src = src;
            el.chunk.classList.remove('hidden'); el.chunk.classList.add('visible');
            
            if(chunkCache.get(chunkId+1)) {
                el.preload.src = chunkCache.get(chunkId+1); 
            }

            try { await el.chunk.play(); } catch(e) { setState(STATE.LIVE); return; }

            const anim = setInterval(() => {
                if(state !== STATE.TIME || el.chunk.paused) { clearInterval(anim); return; }
                const p = el.chunk.currentTime / (el.chunk.duration || 1);
                el.slider.value = (chunkId * CHUNK_SIZE) + (p * CHUNK_SIZE);
            }, 100);

            el.chunk.onended = () => {
                clearInterval(anim);
                chunkId++;
                if(chunkId < totalChunks) playNextChunk();
                else setState(STATE.LIVE);
            };
            
            el.chunk.onerror = () => { setState(STATE.LIVE); };
        }

        function stopTimelapseAndShow() {
            const progress = el.chunk.currentTime / (el.chunk.duration || 1);
            let rawIdx = (chunkId * CHUNK_SIZE) + (progress * CHUNK_SIZE);
            let finalIdx = Math.floor(rawIdx / 10) * 10;
            
            if (finalIdx >= memories.length) finalIdx = memories.length - 1;
            if (finalIdx < 0) finalIdx = 0;

            setState(STATE.PLAY).then(() => {
                el.slider.value = finalIdx;
                playMem(finalIdx);
            });
        }

        // --- HW ---
        async function loadDevices() {
            try {
                const d=await navigator.mediaDevices.enumerateDevices();
                const v=document.getElementById('selCam'); const a=document.getElementById('selMic');
                v.innerHTML=""; a.innerHTML="";
                d.forEach(x=>{
                    const o=document.createElement('option'); o.value=x.deviceId; o.text=x.label||x.kind;
                    if(x.kind==='videoinput')v.appendChild(o);
                    if(x.kind==='audioinput')a.appendChild(o);
                });
            }catch(e){}
        }

        async function initCam() {
            try {
                if(el.live.srcObject)el.live.srcObject.getTracks().forEach(t=>t.stop());
                const stream=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:camId}},audio:true});
                el.live.srcObject=stream;
                const ac=new AudioContext();
                analyser=ac.createAnalyser();
                const src=ac.createMediaStreamSource(stream);
                src.connect(analyser);
                dataArray=new Uint8Array(analyser.frequencyBinCount);
            }catch(e){}
        }

        function startAnalysis() {
            clearInterval(analysisInterval);
            analysisInterval=setInterval(()=>{
                if(state!==STATE.LIVE)return;
                ctxAn.drawImage(el.live,0,0,64,64);
                const d=ctxAn.getImageData(0,0,64,64).data;
                let r=0,g=0,b=0;
                for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];}
                const c=d.length/4;
                stats.bri=Math.round((r/c+g/c+b/c)/3);
                document.getElementById('bBri').style.width=(stats.bri/2.55)+"%";
                document.getElementById('bCol').style.backgroundColor=`rgb(${Math.round(r/c)},${Math.round(g/c)},${Math.round(b/c)})`;
                if(analyser){
                    analyser.getByteFrequencyData(dataArray);
                    stats.vol=dataArray[10];
                    document.getElementById('bVol').style.width=(stats.vol/2.55)+"%";
                }
            },2000);
        }
        function stopAnalysis(){clearInterval(analysisInterval);}

        function startRec() {
            if(!el.live.srcObject)return;
            mediaRecorder=new MediaRecorder(el.live.srcObject,{mimeType:'video/webm;codecs=vp9'});
            mediaRecorder.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};
            mediaRecorder.onstop=upload;
            mediaRecorder.start();
            document.getElementById('uploadInd').style.background = 'yellow';
            document.getElementById('uploadInd').innerText = 'REC';
            document.getElementById('uploadInd').style.display = 'block';
            clearInterval(recInterval);
            recInterval=setInterval(()=>{if(mediaRecorder.state==='recording')mediaRecorder.stop();},15000);
        }
        function stopRec(){
            if(mediaRecorder&&mediaRecorder.state!=='inactive')mediaRecorder.stop();
            clearInterval(recInterval);
            document.getElementById('uploadInd').style.display = 'none';
        }

        async function upload() {
            if(chunks.length===0||!octokit||state!==STATE.LIVE)return;
            document.getElementById('uploadInd').style.background = 'orange';
            document.getElementById('uploadInd').innerText = 'UPLOADING...';
            const blob=new Blob(chunks,{type:'video/webm'}); chunks=[];
            const reader=new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend=async()=>{
                const b64=reader.result.split(',')[1];
                const nm=`mem_${Date.now()}.webm`;
                try{
                    await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}',{
                        owner:REPO.owner,repo:REPO.name,path:`memories/${nm}`,message:'new',content:b64
                    });
                    memories.push({filename:nm,timestamp:Date.now()});
                    el.slider.max=memories.length;
                    if(state===STATE.LIVE)el.slider.value=memories.length;
                    document.getElementById('uploadInd').style.background = 'lime';
                    document.getElementById('uploadInd').innerText = 'OK';
                    setTimeout(() => { if(state===STATE.LIVE){document.getElementById('uploadInd').style.background='yellow';document.getElementById('uploadInd').innerText='REC';}}, 2000);
                }catch(e){console.error(e);}
                if(state===STATE.LIVE)mediaRecorder.start();
            };
        }

        async function loadDB(){
            try{
                const r=await fetch(`https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/database.json?t=${Date.now()}`);
                memories=await r.json();
                el.slider.max=memories.length;
            }catch(e){}
        }

        function updateClock(){
            const n=new Date();
            document.getElementById('timeDisplay').innerText=n.toLocaleTimeString('cs-CZ');
            document.getElementById('dateDisplay').innerText=n.toLocaleDateString('cs-CZ');
        }
    </script>
</body>
</html>
