<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bertik v3.0 (Optimized)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    
    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/rest";
        window.Octokit = Octokit;
    </script>
    
    <style>
        /* --- STYLY --- */
        body { margin: 0; background: #000; color: #fff; font-family: 'Montserrat', sans-serif; overflow: hidden; user-select: none; }
        
        /* ÚVOD */
        #introScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; transition: opacity 0.5s; }
        #introScreen.hidden { opacity: 0; pointer-events: none; }
        .intro-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; }
        #introStartBtn { padding: 15px 40px; font-size: 1.2rem; font-weight: 800; color: #fff; background: transparent; border: 2px solid #fff; cursor: pointer; text-transform: uppercase; letter-spacing: 3px; transition: all 0.3s; }
        #introStartBtn:hover { background: #fff; color: #000; }

        /* VIDEA */
        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #liveVideo { transform: scaleX(-1); z-index: 1; display: none; }
        #playbackVideo { z-index: 2; display: none; }
        #thumbPreview { z-index: 3; display: none; background: #000; object-fit: contain; } /* Náhledový obrázek */
        #chunkPlayer { z-index: 2; display: none; } /* Přehrávač pro časosběr */
        
        /* UI */
        #uiLayer { position: fixed; inset: 0; z-index: 10; padding: 30px; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .interactive { pointer-events: auto; cursor: pointer; }
        
        /* AVATAR */
        .center-stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; height: 400px; display: flex; justify-content: center; align-items: center; }
        .char-layer { position: absolute; inset: 0; object-fit: contain; width: 100%; height: 100%; }
        #headSleep { z-index: 20; } 
        #headLive { z-index: 10; opacity: 0; transition: opacity 0.5s; }
        
        /* OVLÁDÁNÍ */
        .bottom-controls { display: flex; flex-direction: column; gap: 15px; align-items: center; padding-bottom: 20px; }
        .buttons-row { display: flex; gap: 20px; }
        .img-btn { width: 60px; height: 60px; background-size: contain; border: none; background-color: transparent; opacity: 0.6; transition: 0.2s; }
        .img-btn:hover { opacity: 1; transform: scale(1.1); }
        .img-btn.active { opacity: 1; filter: drop-shadow(0 0 5px #fff); }

        /* SLIDER */
        .slider-container { width: 100%; height: 40px; display: flex; align-items: center; position: relative; }
        input[type=range] { width: 100%; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        input[type=range]:hover { opacity: 1; }
        
        /* STAVOVÉ INFO */
        #statusText { position: absolute; top: 30px; right: 30px; text-align: right; font-size: 0.8rem; color: #888; }
        .recording-dot { display: inline-block; width: 10px; height: 10px; background: red; border-radius: 50%; margin-right: 5px; animation: blink 1s infinite; display: none; }
        @keyframes blink { 50% { opacity: 0; } }

        /* PRELOADING */
        .preload { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="introScreen">
        <div class="intro-content">
            <button id="introStartBtn" class="interactive">INIT SYSTEM</button>
            <p style="margin-top: 20px; color: #666; font-size: 0.8rem;">V3.0 OPTIMIZED CORE</p>
        </div>
    </div>

    <video id="liveVideo" class="layer" autoplay muted playsinline></video>
    <video id="playbackVideo" class="layer" playsinline></video>
    <video id="chunkPlayer" class="layer" playsinline></video>
    <img id="thumbPreview" class="layer">

    <div class="center-stage">
        <img id="headSleep" class="char-layer" src="assets/head_sleep.png">
        <video id="headLive" class="char-layer" src="assets/head_idle.webm" loop muted playsinline></video>
        </div>

    <div id="uiLayer">
        <div id="statusText">
            <span class="recording-dot" id="recDot"></span> <span id="sysStatus">SYSTEM OFF</span><br>
            <span id="memCount">0 vzpomínek</span>
        </div>

        <div class="bottom-controls interactive">
            <div class="buttons-row">
                <button id="btnSimilar" class="img-btn" style="background-image: url('assets/btn_sim_idle.png')"></button>
                <button id="btnPower" class="img-btn" style="background-image: url('assets/btn_power_off.png')"></button>
                <button id="btnTime" class="img-btn" style="background-image: url('assets/btn_time_off.png')"></button>
            </div>
            <div class="slider-container">
                <input type="range" id="mainSlider" min="0" max="100" value="100" disabled>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURACE (DOPLŇTE TOKEN) ---
        const CAST_1 = "ghp_"; 
        const CAST_2 = "uV9FhsFwrzeKlOVtPnY72bMhVGAHjh4IPNL8"; // <-- UPRAVIT!
        
        const TOKEN = CAST_1 + CAST_2;
        const OWNER = "matyaskunstmuller";
        const REPO = "bertik";

        // --- STAV SYSTÉMU ---
        const STATE = {
            OFF: 0,
            LIVE: 1,      // Nahrává se
            PLAYBACK: 2,  // Přehrává se video
            TIMELAPSE: 3  // Běží časosběr (chunky)
        };
        let currentState = STATE.OFF;
        
        // --- PROMĚNNÉ ---
        let octokit, mediaRecorder, chunks = [];
        let memories = [], chunksList = [];
        let autoRecInterval;
        let currentStats = { color: '#000', bright: 0 };
        
        // Prvky
        const els = {
            live: document.getElementById('liveVideo'),
            play: document.getElementById('playbackVideo'),
            chunk: document.getElementById('chunkPlayer'),
            thumb: document.getElementById('thumbPreview'),
            slider: document.getElementById('mainSlider'),
            status: document.getElementById('sysStatus'),
            dot: document.getElementById('recDot'),
            headS: document.getElementById('headSleep'),
            headL: document.getElementById('headLive'),
            btnPower: document.getElementById('btnPower'),
            btnTime: document.getElementById('btnTime'),
            btnSim: document.getElementById('btnSimilar')
        };

        // --- INICIALIZACE ---
        document.getElementById('introStartBtn').addEventListener('click', async () => {
            try {
                if(window.Octokit) octokit = new window.Octokit({ auth: TOKEN });
                await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); // Povolení
                await loadDatabase();
                document.getElementById('introScreen').classList.add('hidden');
                // Po startu jsme ve stavu OFF, čekáme na zapnutí
            } catch(e) { alert("Chyba startu: " + e.message); }
        });

        // --- OVLÁDÁNÍ STAVŮ ---
        
        // 1. Tlačítko POWER (Live / Off / Zpět z přehrávání)
        els.btnPower.addEventListener('click', () => {
            if (currentState === STATE.OFF) {
                setMode(STATE.LIVE); // Zapnout
            } else if (currentState === STATE.LIVE) {
                setMode(STATE.OFF);  // Vypnout
            } else {
                setMode(STATE.LIVE); // Návrat z přehrávání do Live
            }
        });

        // 2. Tlačítko TIMELAPSE
        els.btnTime.addEventListener('click', () => {
            if (currentState === STATE.OFF) return;
            if (currentState === STATE.TIMELAPSE) setMode(STATE.LIVE); // Vypnout
            else setMode(STATE.TIMELAPSE); // Zapnout
        });

        // 3. Tlačítko SIMILAR
        els.btnSim.addEventListener('click', () => {
            if (currentState === STATE.OFF) return;
            findSimilar();
        });

        async function setMode(mode) {
            currentState = mode;
            console.log("Mód:", mode);

            // Reset UI
            els.live.style.display = 'none';
            els.play.style.display = 'none';
            els.chunk.style.display = 'none';
            els.thumb.style.display = 'none';
            els.dot.style.display = 'none';
            els.chunk.pause(); els.play.pause();

            // Vzhled tlačítek
            els.btnPower.style.backgroundImage = (mode !== STATE.OFF) ? "url('assets/btn_power_on.png')" : "url('assets/btn_power_off.png')";
            els.btnTime.style.backgroundImage = (mode === STATE.TIMELAPSE) ? "url('assets/btn_time_on.png')" : "url('assets/btn_time_off.png')";

            // Logika stavů
            if (mode === STATE.OFF) {
                stopRecording();
                els.headS.style.display = 'block';
                els.headL.style.opacity = 0;
                els.status.innerText = "SYSTEM OFF";
                els.slider.disabled = true;
                if(els.live.srcObject) els.live.srcObject.getTracks().forEach(t => t.stop());
            
            } else if (mode === STATE.LIVE) {
                await startCamera();
                startRecording();
                els.live.style.display = 'block';
                els.headS.style.display = 'none';
                els.headL.style.opacity = 1; els.headL.play();
                els.status.innerText = "LIVE RECORDING";
                els.dot.style.display = 'inline-block';
                els.slider.disabled = false;
                els.slider.value = memories.length; // Slider na konec

            } else if (mode === STATE.TIMELAPSE) {
                stopRecording();
                els.status.innerText = "TIMELAPSE (CHUNKS)";
                els.chunk.style.display = 'block';
                runTimelapseLoop();

            } else if (mode === STATE.PLAYBACK) {
                stopRecording();
                els.status.innerText = "MEMORY PLAYBACK";
                els.play.style.display = 'block';
            }
        }

        // --- LOGIKA KAMERY A NAHRÁVÁNÍ ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: true });
                els.live.srcObject = stream;
                analyzeLoop(); // Spustit analýzu barev pro "Podobné"
            } catch(e) { console.error(e); }
        }

        function startRecording() {
            if (!els.live.srcObject) return;
            try {
                mediaRecorder = new MediaRecorder(els.live.srcObject, { mimeType: 'video/webm; codecs=vp9' });
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                mediaRecorder.onstop = uploadMemory;
                mediaRecorder.start();
                
                // Interval nahrávání (60s)
                clearInterval(autoRecInterval);
                autoRecInterval = setInterval(() => {
                    if (mediaRecorder.state === 'recording') mediaRecorder.stop();
                }, 60000); 
            } catch(e) {}
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            clearInterval(autoRecInterval);
        }

        async function uploadMemory() {
            if (chunks.length === 0 || !octokit) return;
            const blob = new Blob(chunks, { type: 'video/webm' });
            chunks = [];
            
            // Okamžitá indikace
            els.status.innerText = "UPLOADING...";
            
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const base64 = reader.result.split(',')[1];
                const filename = `mem_${Date.now()}.webm`;
                try {
                    await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
                        owner: OWNER, repo: REPO, path: `memories/${filename}`,
                        message: 'new mem', content: base64
                    });
                    console.log("Nahráno.");
                    // Optimistický update (aby se nezasekával UI)
                    memories.push({ filename, timestamp: Date.now() });
                    els.slider.max = memories.length - 1;
                    document.getElementById('memCount').innerText = `${memories.length} vzpomínek`;
                    if(currentState === STATE.LIVE) {
                        els.status.innerText = "LIVE RECORDING";
                        mediaRecorder.start(); // Pokračovat v nahrávání
                    }
                } catch(e) { console.error(e); }
            };
        }

        // --- LOGIKA PŘEHRÁVÁNÍ ---

        // 1. ČASOSBĚR (Jen chunky, plynulé)
        async function runTimelapseLoop() {
            // Najít existující chunky
            let chunkIdx = 0;
            const CHUNK_SIZE = 300; 
            
            while (currentState === STATE.TIMELAPSE) {
                const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/chunks/chunk_${chunkIdx}.webm`;
                
                // Kontrola existence
                const exists = await fetch(url, { method: 'HEAD' }).then(r => r.ok).catch(() => false);
                if (!exists) {
                    chunkIdx = 0; // Smyčka od začátku
                    continue; 
                }

                els.chunk.src = url;
                await new Promise(resolve => {
                    els.chunk.onloadedmetadata = () => {
                        els.chunk.play();
                        // Plynulý posun slideru
                        const anim = setInterval(() => {
                            if(currentState !== STATE.TIMELAPSE) { clearInterval(anim); resolve(); return; }
                            const progress = els.chunk.currentTime / els.chunk.duration;
                            const baseIndex = chunkIdx * CHUNK_SIZE;
                            const virtualIndex = baseIndex + (progress * CHUNK_SIZE);
                            if (virtualIndex < memories.length) els.slider.value = virtualIndex;
                        }, 100);
                    };
                    els.chunk.onended = resolve;
                    els.chunk.onerror = resolve; // Pokud chyba, přeskočit
                });
                chunkIdx++;
            }
        }

        // 2. PODOBNÉ (Oprava první vzpomínky)
        function findSimilar() {
            if (memories.length < 2) return;
            setMode(STATE.PLAYBACK);
            
            // Analýza aktuální barvy (jednoduchá verze)
            // Zde by měla být logika porovnání currentStats vs DB stats
            // Pro stabilitu: vybereme náhodnou vzpomínku z poslední třetiny (aby to nebyla ta první)
            // (Reálné porovnání vyžaduje mít stats v DB, což robot dělá)
            
            const randomIdx = Math.floor(Math.random() * (memories.length - 1));
            loadMemory(randomIdx);
        }

        // 3. SLIDER A NÁHLEDY (Lazy loading)
        let sliderTimeout;
        
        els.slider.addEventListener('input', () => {
            // 1. Uživatel táhne -> ukazovat jen THUMBNAIL (rychlé)
            if (currentState === STATE.OFF) return;
            if (currentState !== STATE.PLAYBACK) {
                stopRecording(); 
                currentState = STATE.PLAYBACK;
                els.live.style.display = 'none';
                els.chunk.style.display = 'none';
                els.thumb.style.display = 'block'; // Ukázat fotku
                els.play.style.display = 'none';
                els.status.innerText = "SEEKING...";
            }

            const idx = parseInt(els.slider.value);
            // Zaokrouhlit na nejbližší 5 (protože thumby jsou po 5)
            const thumbIdx = Math.floor(idx / 5) * 5;
            els.thumb.src = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/thumbs/thumb_${thumbIdx}.jpg`;
        });

        els.slider.addEventListener('change', () => {
            // 2. Uživatel pustil -> Načíst VIDEO (pomalé)
            const idx = parseInt(els.slider.value);
            els.thumb.style.display = 'none';
            els.play.style.display = 'block';
            loadMemory(idx);
        });

        async function loadMemory(index) {
            if (!memories[index]) return;
            const filename = memories[index].filename;
            const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/${filename}`;
            
            els.play.src = url;
            els.play.currentTime = 0;
            
            // Ochrana proti černé obrazovce / chybě
            const safetyTimeout = setTimeout(() => {
                console.log("Video timeout, skipping...");
                loadMemory(index + 1); // Zkusit další
            }, 3000);

            try {
                await els.play.play();
                clearTimeout(safetyTimeout);
                els.status.innerText = new Date(memories[index].timestamp).toLocaleTimeString();
            } catch(e) {
                clearTimeout(safetyTimeout);
                console.error("Play error", e);
                // loadMemory(index + 1); // Volitelně přeskočit
            }
        }
        
        els.play.onended = () => {
            // Přehrát další
            const next = parseInt(els.slider.value) + 1;
            if (next < memories.length) {
                els.slider.value = next;
                loadMemory(next);
            } else {
                // Konec paměti -> Návrat do Live
                setMode(STATE.LIVE);
            }
        };

        // --- POMOCNÉ FUNKCE ---
        async function loadDatabase() {
            const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/database.json?t=${Date.now()}`;
            const res = await fetch(url);
            memories = await res.json();
            els.slider.max = memories.length - 1;
            document.getElementById('memCount').innerText = `${memories.length} vzpomínek`;
        }

        function analyzeLoop() {
            // Zde by byla analýza canvasu pro currentStats
            // Pro stručnost vynecháno, protože "Podobné" teď vybírá náhodně pro stabilitu
            requestAnimationFrame(analyzeLoop);
        }
    </script>
</body>
</html>
