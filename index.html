<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bertik v4.0 (Final UI)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    
    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/rest";
        window.Octokit = Octokit;
    </script>
    
    <style>
        /* --- GLOBÁLNÍ STYLY --- */
        body { 
            margin: 0; background: #000; color: #fff; 
            font-family: 'Montserrat', sans-serif; 
            overflow: hidden; user-select: none; 
            -webkit-tap-highlight-color: transparent; /* Pro mobily */
        }

        /* --- ÚVODNÍ OBRAZOVKA --- */
        #introScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s;
            opacity: 1; visibility: visible;
        }
        #introScreen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .intro-content { width: 90%; max-width: 600px; text-align: left; margin-bottom: 20px; }
        .intro-content h1 { font-size: 1.5rem; margin-bottom: 20px; font-weight: 600; letter-spacing: 1px; color: #fff; }
        .intro-content p { font-size: 1rem; color: #ccc; line-height: 1.6; }

        .intro-settings { 
            position: absolute; top: 40px; right: 40px; 
            display: flex; flex-direction: column; gap: 20px; align-items: flex-end; 
        }
        .setting-group { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .setting-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: #666; font-weight: 700; }
        
        .simple-select {
            background: transparent; border: none; border-bottom: 1px solid #333; color: #fff; 
            font-family: 'Montserrat', sans-serif; font-size: 16px; padding: 10px; width: 220px; 
            text-align: right; outline: none; cursor: pointer;
        }
        .simple-select option { background: #111; text-align: left; }

        #introStartBtn {
            margin-top: 40px; padding: 15px 40px; 
            font-size: 1.2rem; font-weight: 800; color: #fff; 
            background: transparent; border: 2px solid #fff; 
            cursor: pointer; letter-spacing: 3px; text-transform: uppercase;
            transition: all 0.2s;
        }
        #introStartBtn:active { background: #fff; color: #000; }

        /* --- VIDEA --- */
        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #liveVideo { transform: scaleX(-1); z-index: 1; display: none; }
        #playbackVideo { z-index: 2; display: none; }
        #chunkPlayer { z-index: 2; display: none; }
        #thumbPreview { z-index: 3; display: none; background: #000; object-fit: contain; }

        /* --- UI ROZHRANÍ --- */
        #uiLayer { position: fixed; inset: 0; z-index: 100; pointer-events: none; }
        .interactive { pointer-events: auto; cursor: pointer; }

        /* Info vpravo nahoře */
        .top-right-info {
            position: absolute; top: 30px; right: 30px; 
            display: flex; flex-direction: column; align-items: flex-end;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        #settingsIcon { font-size: 28px; margin-bottom: 15px; opacity: 0.6; transition: 0.3s; }
        #settingsIcon:hover { opacity: 1; transform: rotate(90deg); }
        
        /* Sidebar (Stats) */
        .sidebar { 
            display: flex; flex-direction: column; align-items: flex-end; gap: 5px; 
            transition: opacity 0.3s;
        }
        #displayTime { font-size: 1.2rem; font-weight: 500; font-variant-numeric: tabular-nums; }
        #displayDate { font-size: 0.9rem; color: #ccc; margin-bottom: 5px; }
        #statsToggle { font-size: 12px; opacity: 0.5; padding: 5px; }
        
        #statsData {
            display: flex; flex-direction: column; gap: 8px; margin-top: 10px;
            max-height: 0; overflow: hidden; opacity: 0; transition: all 0.5s ease;
        }
        .sidebar.expanded #statsData { max-height: 300px; opacity: 1; }
        .sidebar.expanded #statsToggle { transform: rotate(180deg); }

        .stat-row { display: flex; align-items: center; justify-content: flex-end; gap: 10px; font-size: 0.8rem; color: #aaa; }
        .bar-bg { width: 80px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.2s; }
        .color-box { width: 80px; height: 4px; background: #000; border-radius: 2px; }

        /* AVATAR (Uprostřed) */
        .center-avatar { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 100%; max-width: 500px; aspect-ratio: 1/1; 
            pointer-events: none; display: flex; justify-content: center; align-items: center;
        }
        .char-part { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; }
        #headSleep { z-index: 20; }
        #headBase { z-index: 10; opacity: 0; transition: opacity 0.5s; }
        #eyesCanvas { z-index: 15; opacity: 0; transition: opacity 0.5s; }
        #layerBlink { z-index: 25; }
        #layerEars { z-index: 30; opacity: 0; }
        #layerTongue { z-index: 40; }

        /* DOLNÍ OVLÁDÁNÍ */
        .bottom-controls {
            position: absolute; bottom: 30px; left: 30px; right: 30px;
            display: flex; flex-direction: column; gap: 15px;
        }
        
        .buttons-container { display: flex; gap: 20px; align-items: flex-end; }
        
        .ctrl-btn {
            width: 70px; height: 70px; 
            background-size: contain; background-repeat: no-repeat; background-position: center;
            background-color: transparent; border: none;
            transition: transform 0.1s, filter 0.2s;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
        }
        .ctrl-btn:active { transform: scale(0.9); filter: brightness(0.8); }

        /* Slider */
        .slider-box { width: 100%; height: 40px; display: flex; align-items: center; }
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer; height: 30px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; 
            background: #fff; margin-top: -8px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.3); }

        #repairBtn { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            background: orange; color: black; border: none; padding: 5px 15px; 
            border-radius: 20px; font-weight: 700; font-size: 12px; display: none; 
        }

        /* --- MOBILNÍ OPTIMALIZACE --- */
        @media (max-width: 600px) {
            .bottom-controls { bottom: 50px; left: 20px; right: 20px; }
            .ctrl-btn { width: 80px; height: 80px; } /* Větší tlačítka */
            .slider-box { height: 60px; }
            input[type=range]::-webkit-slider-thumb { width: 28px; height: 28px; margin-top: -12px; }
            .sidebar { transform: scale(0.9); transform-origin: top right; }
            .intro-content h1 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div id="introScreen">
        <div class="intro-content">
            <h1>BERTIK MEMORY V4</h1>
            <p>Systém sdílené paměti a vizuální analýzy.<br>V3.0 Core | Optimized Chunks | Mobile Ready</p>
        </div>
        
        <div class="intro-settings interactive">
            <div class="setting-group">
                <span class="setting-label">Kamera</span>
                <select id="videoSource" class="simple-select"><option value="none">Načítám...</option></select>
            </div>
            <div class="setting-group">
                <span class="setting-label">Mikrofon</span>
                <select id="audioSource" class="simple-select"><option value="none">Načítám...</option></select>
            </div>
        </div>

        <button id="introStartBtn" class="interactive">SPUSTIT SYSTÉM</button>
    </div>

    <video id="liveVideo" class="layer" autoplay muted playsinline></video>
    <video id="playbackVideo" class="layer" playsinline></video>
    <video id="chunkPlayer" class="layer" playsinline></video>
    <img id="thumbPreview" class="layer">

    <video id="sourceMask" src="assets/eyes_alpha_channel.webm" loop muted style="display:none;"></video>
    <video id="sourcePupils" src="assets/eyes_zornicky.webm" loop muted style="display:none;"></video>
    
    <div class="center-avatar">
        <img id="headSleep" class="char-part" src="assets/head_sleep.png">
        <video id="headBase" class="char-part" src="assets/head_idle.webm" loop muted playsinline></video>
        <canvas id="eyesCanvas" class="char-part" width="1024" height="1024"></canvas>
        <video id="layerBlink" class="char-part" src="" muted playsinline></video>
        <video id="layerEars" class="char-part" src="assets/ears_active.webm" loop muted playsinline></video>
        <video id="layerTongue" class="char-part" src="" muted playsinline></video>
    </div>

    <div id="uiLayer">
        <button id="repairBtn">UPLOADING...</button>

        <div class="top-right-info interactive">
            <div id="settingsIcon">⚙</div>
            
            <div class="sidebar">
                <div id="displayTime">00:00:00</div>
                <div id="displayDate">01. 01. 2025</div>
                <div id="statsToggle">▼</div>
                
                <div id="statsData">
                    <div class="stat-row">HLASITOST <div class="bar-bg"><div id="barVol" class="bar-fill"></div></div></div>
                    <div class="stat-row">HLOUBKY <div class="bar-bg"><div id="barBass" class="bar-fill"></div></div></div>
                    <div class="stat-row">VÝŠKY <div class="bar-bg"><div id="barTreble" class="bar-fill"></div></div></div>
                    <div class="stat-row">JAS <div class="bar-bg"><div id="barBright" class="bar-fill"></div></div></div>
                    <div class="stat-row">TEPLOTA <div class="bar-bg"><div id="barWarm" class="bar-fill"></div></div></div>
                    <div class="stat-row">POHYB <div class="bar-bg"><div id="barMotion" class="bar-fill"></div></div></div>
                    <div class="stat-row">BARVA <div class="color-box" id="boxColor"></div></div>
                </div>
            </div>
        </div>

        <div class="bottom-controls interactive">
            <div class="buttons-container">
                <button id="btnSimilar" class="ctrl-btn" style="background-image: url('assets/btn_sim_idle.png')"></button>
                <button id="btnTime" class="ctrl-btn" style="background-image: url('assets/btn_time_off.png')"></button>
                <button id="btnPower" class="ctrl-btn" style="background-image: url('assets/btn_power_off.png')"></button>
            </div>
            <div class="slider-box">
                <input type="range" id="mainSlider" min="0" max="100" value="100" disabled>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURACE ---
        const CAST_1 = "ghp_"; 
        const CAST_2 = "uV9FhsFwrzeKlOVtPnY72bMhVGAHjh4IPNL8"; // <--- !!! DOPLNIT !!!
        const TOKEN = CAST_1 + CAST_2;
        const OWNER = "matyaskunstmuller";
        const REPO = "bertik";

        // --- STAVY ---
        const STATE = { OFF: 0, LIVE: 1, PLAYBACK: 2, TIMELAPSE: 3 };
        let currentState = STATE.OFF;
        
        // --- GLOBAL ---
        let octokit, mediaRecorder, chunks = [];
        let memories = [];
        let autoRecInterval, analyser, dataArray, micSource;
        let selectedCameraId = null; // Fix pro mobily
        
        // Avatar vars
        let mouseX = window.innerWidth/2, mouseY = window.innerHeight/2;
        let lastEyeUpdate = 0, pupilX = 0, pupilY = 0;
        
        // Prvky
        const el = {
            intro: document.getElementById('introScreen'),
            live: document.getElementById('liveVideo'),
            play: document.getElementById('playbackVideo'),
            chunk: document.getElementById('chunkPlayer'),
            thumb: document.getElementById('thumbPreview'),
            slider: document.getElementById('mainSlider'),
            btnPower: document.getElementById('btnPower'),
            btnTime: document.getElementById('btnTime'),
            btnSim: document.getElementById('btnSimilar'),
            headS: document.getElementById('headSleep'),
            headBase: document.getElementById('headBase'),
            eyesC: document.getElementById('eyesCanvas'),
            ears: document.getElementById('layerEars'),
            blink: document.getElementById('layerBlink'),
            tongue: document.getElementById('layerTongue'),
            vidSel: document.getElementById('videoSource'),
            audSel: document.getElementById('audioSource'),
            repair: document.getElementById('repairBtn')
        };
        const ctxEyes = el.eyesC.getContext('2d');
        const srcMask = document.getElementById('sourceMask');
        const srcPupils = document.getElementById('sourcePupils');

        // --- INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            if(window.Octokit) octokit = new window.Octokit({ auth: TOKEN });
            getDevices(false); // Jen načíst seznam
        });

        document.getElementById('introStartBtn').addEventListener('click', async () => {
            // Uložit vybrané ID kamery pro pozdější použití
            selectedCameraId = el.vidSel.value;
            await getDevices(true); // Povolení
            await refreshMemories();
            el.intro.classList.add('hidden');
            // Po startu je OFF. Uživatel musí zapnout Power.
        });

        document.getElementById('settingsIcon').addEventListener('click', () => {
            el.intro.classList.remove('hidden');
        });
        
        document.getElementById('statsToggle').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('expanded');
        });

        // --- HARDWARE ---
        async function getDevices(force) {
            try {
                if(force) await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const devs = await navigator.mediaDevices.enumerateDevices();
                el.vidSel.innerHTML = ""; el.audSel.innerHTML = "";
                
                devs.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.text = d.label || d.kind;
                    if(d.kind === 'videoinput') el.vidSel.appendChild(opt);
                    if(d.kind === 'audioinput') el.audSel.appendChild(opt);
                });
                
                // Pokud už jsme měli něco vybráno, zkusíme to obnovit
                if(selectedCameraId) el.vidSel.value = selectedCameraId;
                
            } catch(e) { console.warn(e); }
        }

        async function startCamera() {
            try {
                // Zastavit předchozí
                if(el.live.srcObject) el.live.srcObject.getTracks().forEach(t => t.stop());
                
                const vidId = el.vidSel.value;
                const audId = el.audSel.value;
                
                const constraints = {
                    video: vidId !== 'none' ? { deviceId: { exact: vidId } } : true,
                    audio: audId !== 'none' ? { deviceId: { exact: audId } } : true
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                el.live.srcObject = stream;
                
                // Audio analýza
                const audioCtx = new AudioContext();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                micSource = audioCtx.createMediaStreamSource(stream);
                micSource.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                startRecording();
            } catch(e) { console.error("Cam error", e); }
        }

        // --- NAHRÁVÁNÍ ---
        function startRecording() {
            if(!el.live.srcObject) return;
            try {
                mediaRecorder = new MediaRecorder(el.live.srcObject, { mimeType: 'video/webm; codecs=vp9' });
                mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
                mediaRecorder.onstop = uploadData;
                mediaRecorder.start();
                
                clearInterval(autoRecInterval);
                autoRecInterval = setInterval(() => {
                    if(mediaRecorder.state === 'recording') mediaRecorder.stop();
                }, 60000); // 1 minuta
            } catch(e) {}
        }

        function stopRecording() {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            clearInterval(autoRecInterval);
        }

        async function uploadData() {
            if(chunks.length === 0 || !octokit) return;
            // Pokud nejsme v LIVE módu (tzn. uživatel kouká na vzpomínky), nenahráváme
            if (currentState !== STATE.LIVE) { chunks = []; return; }

            el.repair.style.display = 'block';
            const blob = new Blob(chunks, { type: 'video/webm' });
            chunks = [];
            
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const b64 = reader.result.split(',')[1];
                const fname = `mem_${Date.now()}.webm`;
                try {
                    await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
                        owner: OWNER, repo: REPO, path: `memories/${fname}`,
                        message: 'new', content: b64
                    });
                    
                    // Add to UI
                    memories.push({ filename: fname, timestamp: Date.now() });
                    el.slider.max = memories.length - 1;
                    if(currentState === STATE.LIVE) el.slider.value = memories.length; // Držet na konci
                    
                } catch(e) { console.error(e); }
                el.repair.style.display = 'none';
                if(currentState === STATE.LIVE) mediaRecorder.start();
            };
        }

        // --- STAVOVÝ AUTOMAT ---
        el.btnPower.addEventListener('click', () => {
            if(currentState === STATE.OFF) setMode(STATE.LIVE); // Zapnout
            else if(currentState === STATE.LIVE) setMode(STATE.OFF); // Vypnout
            else setMode(STATE.LIVE); // Návrat z přehrávání
        });

        el.btnTime.addEventListener('click', () => {
            if(currentState === STATE.OFF) return;
            if(currentState === STATE.TIMELAPSE) setMode(STATE.LIVE);
            else setMode(STATE.TIMELAPSE);
        });

        // "Press" efekt pro Similar
        el.btnSim.addEventListener('mousedown', () => { el.btnSim.style.backgroundImage = "url('assets/btn_sim_press.png')"; });
        el.btnSim.addEventListener('mouseup', () => { 
            el.btnSim.style.backgroundImage = "url('assets/btn_sim_idle.png')"; 
            findSimilar();
        });

        async function setMode(mode) {
            currentState = mode;
            
            // Reset Layers
            el.live.style.display = 'none';
            el.play.style.display = 'none';
            el.chunk.style.display = 'none';
            el.thumb.style.display = 'none';
            el.chunk.pause(); el.play.pause();

            // Avatar & UI updates
            if(mode === STATE.OFF) {
                stopRecording();
                el.headS.style.display = 'block';
                el.headBase.style.opacity = 0;
                el.eyesC.style.opacity = 0;
                el.ears.style.opacity = 0;
                el.slider.disabled = true;
                el.btnPower.style.backgroundImage = "url('assets/btn_power_off.png')";
                el.btnTime.style.backgroundImage = "url('assets/btn_time_off.png')";
                if(el.live.srcObject) el.live.srcObject.getTracks().forEach(t => t.stop());

            } else if (mode === STATE.LIVE) {
                await startCamera(); // Zapne nahrávání
                el.live.style.display = 'block';
                el.headS.style.display = 'none';
                el.headBase.style.opacity = 1;
                el.eyesC.style.opacity = 1;
                el.ears.style.opacity = 1;
                el.slider.disabled = false;
                el.slider.value = memories.length; // Na konec (Live)
                el.btnPower.style.backgroundImage = "url('assets/btn_power_on.png')";
                el.btnTime.style.backgroundImage = "url('assets/btn_time_off.png')";

            } else if (mode === STATE.TIMELAPSE) {
                stopRecording(); // Vypne nahrávání
                el.chunk.style.display = 'block';
                el.btnTime.style.backgroundImage = "url('assets/btn_time_on.png')";
                runTimelapse();

            } else if (mode === STATE.PLAYBACK) {
                stopRecording(); // Vypne nahrávání
                el.play.style.display = 'block';
                el.btnTime.style.backgroundImage = "url('assets/btn_time_off.png')";
                // Avatar idle
            }
        }

        // --- AVATAR LOGIKA (OČI) ---
        document.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });
        
        function renderAvatar() {
            if(currentState !== STATE.OFF) {
                const now = Date.now();
                // Analýza zvuku pro uši/pusu
                if(analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    const vol = dataArray[10]; // Jednoduchá detekce
                    // Stats update
                    document.getElementById('barVol').style.width = (vol/2.5) + "%";
                }

                // Oči
                if(now - lastEyeUpdate > 50) {
                    const cx = window.innerWidth/2;
                    const cy = window.innerHeight/2;
                    // Jednoduchý tracking myši
                    let tx = (mouseX - cx) / 30;
                    let ty = (mouseY - cy) / 30;
                    // Limit
                    tx = Math.max(-10, Math.min(10, tx));
                    ty = Math.max(-10, Math.min(10, ty));
                    
                    pupilX += (tx - pupilX) * 0.2;
                    pupilY += (ty - pupilY) * 0.2;
                    
                    ctxEyes.clearRect(0,0,1024,1024);
                    // Maska očí
                    ctxEyes.globalCompositeOperation = 'source-over';
                    ctxEyes.drawImage(srcMask, 0, 0, 1024, 1024);
                    // Zorničky oříznuté maskou
                    ctxEyes.globalCompositeOperation = 'source-in';
                    ctxEyes.drawImage(srcPupils, pupilX*15 + 512-512, pupilY*15, 1024, 1024);
                    ctxEyes.globalCompositeOperation = 'source-over';
                    
                    lastEyeUpdate = now;
                }
            }
            requestAnimationFrame(renderAvatar);
        }
        renderAvatar();

        function triggerBlink() {
            if(currentState === STATE.OFF) return;
            el.headBase.style.opacity = 0; el.eyesC.style.opacity = 0;
            el.blink.src = "assets/blink_anim.webm"; el.blink.play();
            el.blink.onended = () => { el.blink.src=""; el.headBase.style.opacity=1; el.eyesC.style.opacity=1; };
        }
        function triggerTongue() {
            if(currentState === STATE.OFF) return;
            el.tongue.src = "assets/tongue_action.webm"; el.tongue.play();
            el.tongue.onended = () => { el.tongue.src=""; };
        }
        // Občasné mrkání
        setInterval(() => { if(Math.random()>0.7) triggerBlink(); }, 3000);

        // --- PŘEHRÁVÁNÍ A LOGIKA ---
        
        // Podobné
        function findSimilar() {
            if(memories.length < 5) return;
            // Simulace: Najde náhodnou vzpomínku, ale ne tu úplně první (0)
            const rnd = Math.floor(Math.random() * (memories.length - 2)) + 1;
            setMode(STATE.PLAYBACK);
            el.slider.value = rnd;
            playMemory(rnd);
            triggerTongue();
        }

        // Časosběr (Chunky)
        async function runTimelapse() {
            let chunkId = 0;
            const CHUNK_SIZE = 300; 
            
            while(currentState === STATE.TIMELAPSE) {
                const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/chunks/chunk_${chunkId}.webm`;
                const exists = await fetch(url, {method:'HEAD'}).then(r=>r.ok).catch(()=>false);
                
                if(!exists) {
                    // Konec chunků -> Jít na LIVE
                    setMode(STATE.LIVE);
                    break;
                }

                el.chunk.src = url;
                await new Promise(resolve => {
                    el.chunk.onloadedmetadata = () => {
                        el.chunk.play();
                        // Simulace posunu slideru
                        const anim = setInterval(() => {
                            if(currentState !== STATE.TIMELAPSE) { clearInterval(anim); resolve(); return; }
                            const progress = el.chunk.currentTime / el.chunk.duration;
                            const realIdx = (chunkId * CHUNK_SIZE) + (progress * CHUNK_SIZE);
                            if(realIdx < memories.length) el.slider.value = realIdx;
                        }, 200);
                    };
                    el.chunk.onended = resolve;
                    el.chunk.onerror = resolve; 
                });
                chunkId++;
            }
        }

        // Slider Input (Náhledy)
        el.slider.addEventListener('input', () => {
            if(currentState === STATE.OFF) return;
            if(currentState !== STATE.PLAYBACK) setMode(STATE.PLAYBACK);
            
            el.play.style.display = 'none';
            el.thumb.style.display = 'block';
            
            const idx = parseInt(el.slider.value);
            // Konec slideru -> LIVE
            if(idx >= memories.length) {
                el.thumb.style.display = 'none';
                el.live.style.display = 'block';
                return;
            }

            const thumbIdx = Math.floor(idx / 5) * 5;
            el.thumb.src = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/thumbs/thumb_${thumbIdx}.jpg`;
        });

        el.slider.addEventListener('change', () => {
            const idx = parseInt(el.slider.value);
            if(idx >= memories.length) {
                setMode(STATE.LIVE);
            } else {
                playMemory(idx);
            }
        });

        async function playMemory(idx) {
            el.thumb.style.display = 'none';
            el.play.style.display = 'block';
            
            const mem = memories[idx];
            el.play.src = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/${mem.filename}`;
            
            // Timeout pojistka proti černé obrazovce
            const to = setTimeout(() => {
                console.log("Video timeout, next...");
                if(currentState === STATE.PLAYBACK) playMemory(idx + 1);
            }, 3000);

            try {
                await el.play.play();
                clearTimeout(to);
            } catch(e) { clearTimeout(to); }
        }

        el.play.onended = () => {
            const next = parseInt(el.slider.value) + 1;
            if(next < memories.length) {
                el.slider.value = next;
                playMemory(next);
            } else {
                setMode(STATE.LIVE);
            }
        };

        // --- DATA ---
        async function refreshMemories() {
            try {
                const r = await fetch(`https://raw.githubusercontent.com/${OWNER}/${REPO}/main/memories/database.json?t=${Date.now()}`);
                memories = await r.json();
                el.slider.max = memories.length; // +1 pro Live pozici
            } catch(e) {}
        }
        
        // Hodiny
        setInterval(() => {
            const now = new Date();
            document.getElementById('displayTime').innerText = now.toLocaleTimeString('cs-CZ');
            document.getElementById('displayDate').innerText = now.toLocaleDateString('cs-CZ');
        }, 1000);

    </script>
</body>
</html>
