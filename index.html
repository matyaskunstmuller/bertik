<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bertik v5.0 (Fixed Core)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/rest";
        window.Octokit = Octokit;
    </script>
    
    <style>
        /* --- LAYOUT A VRSTVY --- */
        body { 
            margin: 0; background: #000; color: #fff; 
            font-family: 'Montserrat', sans-serif; overflow: hidden; user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }

        /* 1. VRSTVA: POZADÍ A AVATAR (Z-INDEX 1-5) */
        .avatar-layer { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 100%; max-width: 600px; aspect-ratio: 1/1; 
            pointer-events: none; z-index: 1;
            display: flex; justify-content: center; align-items: center;
        }
        .char-part { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; }
        
        #headSleep { z-index: 5; display: none; } /* Spící */
        #headBase { z-index: 2; transition: opacity 0.1s; } /* Základní */
        #eyesCanvas { z-index: 3; } /* Oči */
        #layerBlink { z-index: 4; opacity: 0; } /* Mrkání */
        #layerTongue { z-index: 4; opacity: 0; } /* Jazyk */
        #layerEars { z-index: 1; } /* Uši (vzadu) */

        /* 2. VRSTVA: VIDEO (Z-INDEX 10) */
        .video-layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; z-index: 10; background: #000; 
            display: none; /* Defaultně skryto */
        }
        #liveVideo { transform: scaleX(-1); } /* Zrcadlení kamery */
        #thumbPreview { z-index: 11; object-fit: contain; background: #000; } /* Náhled při posunu */

        /* 3. VRSTVA: UI (Z-INDEX 100) */
        #uiLayer { position: fixed; inset: 0; z-index: 100; pointer-events: none; }
        .interactive { pointer-events: auto; cursor: pointer; }

        /* INFO VPRAVO NAHOŘE */
        .top-right { 
            position: absolute; top: 20px; right: 20px; 
            display: flex; flex-direction: column; align-items: flex-end; 
            text-shadow: 1px 1px 2px black;
        }
        #settingsBtn { font-size: 24px; opacity: 0.5; margin-bottom: 10px; transition: 0.3s; }
        #settingsBtn:hover { opacity: 1; transform: rotate(90deg); }
        
        .info-box { text-align: right; }
        #timeDisplay { font-size: 1.2rem; font-weight: 600; font-variant-numeric: tabular-nums; }
        #dateDisplay { font-size: 0.8rem; color: #bbb; margin-bottom: 5px; }
        
        #statsContainer { 
            display: flex; flex-direction: column; gap: 4px; margin-top: 5px; 
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;
            transition: opacity 0.3s; opacity: 0; /* Default skryté */
        }
        .info-box:hover #statsContainer { opacity: 1; } /* Ukázat po najetí */

        .stat-row { display: flex; align-items: center; justify-content: flex-end; gap: 8px; font-size: 0.7rem; color: #aaa; }
        .bar-bg { width: 60px; height: 4px; background: #444; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.2s; }
        .color-preview { width: 60px; height: 4px; background: #000; border-radius: 2px; }

        /* OVLÁDÁNÍ VLEVO DOLE */
        .bottom-left { 
            position: absolute; bottom: 30px; left: 30px; right: 30px;
            display: flex; flex-direction: column; gap: 15px; 
        }
        
        .buttons-row { display: flex; gap: 20px; align-items: flex-end; }
        
        .big-btn {
            width: 70px; height: 70px; 
            background-size: contain; background-repeat: no-repeat; background-position: center;
            background-color: transparent; border: none; 
            transition: transform 0.1s, filter 0.2s;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .big-btn:active { transform: scale(0.9); filter: brightness(0.7); }

        /* Slider */
        .slider-wrapper { width: 100%; height: 40px; display: flex; align-items: center; }
        input[type=range] { 
            width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer; 
        }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; 
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; 
            background: #fff; margin-top: -9px; box-shadow: 0 0 10px rgba(0,0,0,0.5); 
        }

        /* Loading & Status */
        #uploadIndicator { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: #ffaa00; color: #000; padding: 5px 15px; border-radius: 20px;
            font-weight: 700; font-size: 11px; display: none; z-index: 200;
        }

        /* Úvodní obrazovka */
        #introLayer {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        #introLayer.hidden { opacity: 0; pointer-events: none; }
        
        .settings-panel { 
            margin-bottom: 30px; text-align: right; 
            display: flex; flex-direction: column; gap: 10px; 
        }
        select { background: #111; color: #fff; border: 1px solid #444; padding: 5px; width: 200px; }
        
        #startSystemBtn {
            padding: 15px 40px; border: 2px solid #fff; background: transparent; 
            color: #fff; font-weight: 800; font-size: 1.2rem; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px;
        }
        #startSystemBtn:hover { background: #fff; color: #000; }

        /* Mobilní úpravy */
        @media (max-width: 600px) {
            .bottom-left { bottom: 60px; left: 20px; right: 20px; }
            .big-btn { width: 80px; height: 80px; }
            #statsContainer { display: none; } /* Na mobilu schovat detaily */
        }
    </style>
</head>
<body>

    <div id="introLayer">
        <h1 style="letter-spacing: 5px; margin-bottom: 40px;">BERTIK MEMORY</h1>
        <div class="settings-panel interactive">
            <label>KAMERA <select id="selVideo"><option>Načítám...</option></select></label>
            <label>AUDIO <select id="selAudio"><option>Načítám...</option></select></label>
        </div>
        <button id="startSystemBtn" class="interactive">ZAPNOUT SYSTÉM</button>
    </div>

    <div class="avatar-layer">
        <img id="headSleep" class="char-part" src="assets/head_sleep.png">
        
        <video id="layerEars" class="char-part" src="assets/ears_active.webm" loop muted playsinline></video>
        <video id="headBase" class="char-part" src="assets/head_idle.webm" loop muted playsinline></video>
        <canvas id="eyesCanvas" class="char-part" width="1024" height="1024"></canvas>
        
        <video id="layerBlink" class="char-part" src="" muted playsinline></video>
        <video id="layerTongue" class="char-part" src="" muted playsinline></video>
    </div>
    
    <video id="sourceMask" src="assets/eyes_alpha_channel.webm" loop muted style="display:none"></video>
    <video id="sourcePupils" src="assets/eyes_zornicky.webm" loop muted style="display:none"></video>

    <video id="liveVideo" class="video-layer" autoplay muted playsinline></video>
    <video id="playbackVideo" class="video-layer" playsinline></video>
    <video id="chunkVideo" class="video-layer" playsinline></video>
    <img id="thumbPreview" class="video-layer"> <div id="uiLayer">
        <div id="uploadIndicator">ODESÍLÁM...</div>

        <div class="top-right interactive">
            <div id="settingsBtn">⚙</div>
            <div class="info-box">
                <div id="timeDisplay">00:00</div>
                <div id="dateDisplay">--.--.----</div>
                <div id="statsContainer">
                    <div class="stat-row">HLASITOST <div class="bar-bg"><div id="fillVol" class="bar-fill"></div></div></div>
                    <div class="stat-row">SVĚTLO <div class="bar-bg"><div id="fillBri" class="bar-fill"></div></div></div>
                    <div class="stat-row">TEPLOTA <div class="bar-bg"><div id="fillWarm" class="bar-fill"></div></div></div>
                    <div class="stat-row">POHYB <div class="bar-bg"><div id="fillMot" class="bar-fill"></div></div></div>
                    <div class="stat-row">BARVA <div class="color-preview" id="fillCol"></div></div>
                </div>
            </div>
        </div>

        <div class="bottom-left interactive">
            <div class="buttons-row">
                <button id="btnSimilar" class="big-btn" style="background-image: url('assets/btn_sim_idle.png')"></button>
                <button id="btnPower" class="big-btn" style="background-image: url('assets/btn_power_off.png')"></button>
                <button id="btnTime" class="big-btn" style="background-image: url('assets/btn_time_off.png')"></button>
            </div>
            <div class="slider-wrapper">
                <input type="range" id="mainSlider" min="0" max="100" value="100" disabled>
            </div>
        </div>
    </div>

    <canvas id="analysisCanvas" width="64" height="64" style="display:none"></canvas>

    <script>
        // --- 1. KONFIGURACE (TOKEN) ---
        const CAST_1 = "ghp_"; 
        const CAST_2 = "uV9FhsFwrzeKlOVtPnY72bMhVGAHjh4IPNL8"; // <--- !!! VLOŽIT ZDE !!!
        const TOKEN = CAST_1 + CAST_2;
        const REPO = { owner: "matyaskunstmuller", name: "bertik" };

        // --- 2. STAVY A PROMĚNNÉ ---
        const STATE = { OFF: 0, LIVE: 1, PLAYBACK: 2, TIMELAPSE: 3 };
        let curState = STATE.OFF;
        
        let octokit;
        let memories = [];
        let mediaRecorder, chunks = [];
        let recInterval, analyser, dataArray;
        let camId = null; // Zapamatovaná kamera
        
        // Analýza
        let currentStats = { r:0, g:0, b:0, bri:0, vol:0 };
        const ctxAnalysis = document.getElementById('analysisCanvas').getContext('2d');

        // Avatar
        let mouseX=window.innerWidth/2, mouseY=window.innerHeight/2;
        let pupilX=0, pupilY=0;
        const ctxEyes = document.getElementById('eyesCanvas').getContext('2d');

        // Elementy
        const ui = {
            live: document.getElementById('liveVideo'),
            play: document.getElementById('playbackVideo'),
            chunk: document.getElementById('chunkVideo'),
            thumb: document.getElementById('thumbPreview'),
            slider: document.getElementById('mainSlider'),
            btnPwr: document.getElementById('btnPower'),
            btnTime: document.getElementById('btnTime'),
            btnSim: document.getElementById('btnSimilar'),
            indicator: document.getElementById('uploadIndicator'),
            headS: document.getElementById('headSleep'),
            headB: document.getElementById('headBase'),
            eyes: document.getElementById('eyesCanvas'),
            blink: document.getElementById('layerBlink'),
            tongue: document.getElementById('layerTongue'),
            ears: document.getElementById('layerEars')
        };

        // --- 3. INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            if(window.Octokit) octokit = new window.Octokit({ auth: TOKEN });
            loadDevices();
            setInterval(updateClock, 1000);
            renderLoop(); // Spustí smyčku (Avatar + Analýza)
        });

        document.getElementById('startSystemBtn').addEventListener('click', async () => {
            camId = document.getElementById('selVideo').value;
            await initHardware();
            await loadDB();
            document.getElementById('introLayer').classList.add('hidden');
            // Po startu je OFF, čeká na tlačítko Power
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('introLayer').classList.remove('hidden');
        });

        // --- 4. OVLÁDÁNÍ (TLAČÍTKA) ---
        
        // POWER
        ui.btnPwr.addEventListener('click', () => {
            if (curState === STATE.OFF) setState(STATE.LIVE);
            else setState(STATE.OFF);
        });

        // TIMELAPSE
        ui.btnTime.addEventListener('click', () => {
            if (curState === STATE.OFF) return;
            if (curState === STATE.TIMELAPSE) setState(STATE.LIVE); // Vypnout -> Live
            else setState(STATE.TIMELAPSE);
        });

        // SIMILAR
        ui.btnSim.addEventListener('mousedown', () => ui.btnSim.style.backgroundImage = "url('assets/btn_sim_press.png')");
        ui.btnSim.addEventListener('mouseup', () => {
            ui.btnSim.style.backgroundImage = "url('assets/btn_sim_idle.png')";
            if (curState !== STATE.OFF) findSimilar();
        });

        // SLIDER
        ui.slider.addEventListener('input', () => {
            // Táhnutí -> Náhled
            if (curState === STATE.OFF) return;
            stopRecording(); // Pauza nahrávání
            
            // UI změny
            ui.live.style.display = 'none';
            ui.play.style.display = 'none';
            ui.chunk.style.display = 'none';
            ui.thumb.style.display = 'block'; // Ukázat fotku
            
            const idx = parseInt(ui.slider.value);
            if (idx >= memories.length) {
                // Konec lišty -> Live náhled (zatím jen černo nebo live video)
                ui.thumb.style.display = 'none';
                ui.live.style.display = 'block';
            } else {
                // Najít nejbližší thumbnail (jsou po 5)
                const tIdx = Math.floor(idx / 5) * 5;
                ui.thumb.src = `https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/thumbs/thumb_${tIdx}.jpg`;
            }
        });

        ui.slider.addEventListener('change', () => {
            // Puštění -> Akce
            const idx = parseInt(ui.slider.value);
            if (idx >= memories.length) {
                setState(STATE.LIVE);
            } else {
                playMemory(idx);
            }
        });

        // --- 5. LOGIKA STAVŮ ---
        async function setState(newState) {
            curState = newState;
            console.log("State:", newState);

            // Reset UI
            ui.live.style.display = 'none';
            ui.play.style.display = 'none';
            ui.chunk.style.display = 'none';
            ui.thumb.style.display = 'none';
            ui.play.pause(); ui.chunk.pause();

            // Tlačítka
            ui.btnPwr.style.backgroundImage = (newState === STATE.OFF) ? "url('assets/btn_power_off.png')" : "url('assets/btn_power_on.png')";
            ui.btnTime.style.backgroundImage = (newState === STATE.TIMELAPSE) ? "url('assets/btn_time_on.png')" : "url('assets/btn_time_off.png')";

            if (newState === STATE.OFF) {
                stopRecording();
                ui.headS.style.display = 'block';
                ui.headB.style.opacity = 0; ui.eyes.style.opacity = 0; ui.ears.style.opacity = 0;
                ui.slider.disabled = true;
                if(ui.live.srcObject) ui.live.srcObject.getTracks().forEach(t=>t.stop());

            } else if (newState === STATE.LIVE) {
                await initHardware(); // Zapne kameru
                startRecording();
                ui.live.style.display = 'block';
                // Avatar ožije
                ui.headS.style.display = 'none';
                ui.headB.style.opacity = 1; ui.eyes.style.opacity = 1; ui.ears.style.opacity = 1;
                ui.headB.play(); ui.ears.play();
                ui.slider.disabled = false;
                ui.slider.value = memories.length; // Posunout na konec

            } else if (newState === STATE.PLAYBACK) {
                stopRecording();
                ui.play.style.display = 'block';
            
            } else if (newState === STATE.TIMELAPSE) {
                stopRecording();
                ui.chunk.style.display = 'block';
                runTimelapse();
            }
        }

        // --- 6. PŘEHRÁVÁNÍ ---
        
        async function playMemory(idx) {
            setState(STATE.PLAYBACK);
            const mem = memories[idx];
            if(!mem) return;

            ui.play.src = `https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/${mem.filename}`;
            ui.slider.value = idx; // Synchronizace lišty

            try {
                await ui.play.play();
            } catch(e) {
                console.log("Chyba videa, další...");
                playMemory(idx + 1); // Skip bad video
            }
        }

        ui.play.onended = () => {
            const next = parseInt(ui.slider.value) + 1;
            if (next < memories.length) playMemory(next);
            else setState(STATE.LIVE); // Konec -> Live
        };

        // PODOBNÉ (Funkční logika)
        function findSimilar() {
            if (memories.length < 2) return;
            
            // Spočítat rozdíl (barva + jas)
            let bestIdx = 0;
            let minDiff = Infinity;

            memories.forEach((mem, i) => {
                if (!mem.stats) return; // Pokud nemá data, přeskočit
                
                // Jednoduchá euklidovská vzdálenost v datech
                const diff = Math.abs(mem.stats.brightness - currentStats.bri) +
                             Math.abs(parseInt(mem.stats.color.slice(1), 16) - parseInt(currentStats.hex.slice(1), 16)); // Hrubý odhad
                
                if (diff < minDiff) {
                    minDiff = diff;
                    bestIdx = i;
                }
            });

            // Fallback: Pokud je bestIdx 0 (podezřelé), dej náhodné
            if (bestIdx === 0) bestIdx = Math.floor(Math.random() * (memories.length - 1));

            playMemory(bestIdx);
            triggerTongue();
        }

        // ČASOSBĚR (Chunky)
        async function runTimelapse() {
            let chunkId = 0;
            const CHUNK_SIZE = 300; 

            while(curState === STATE.TIMELAPSE) {
                const url = `https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/chunks/chunk_${chunkId}.webm`;
                const exists = await fetch(url, {method:'HEAD'}).then(r=>r.ok).catch(()=>false);
                
                if (!exists) { setState(STATE.LIVE); break; } // Konec -> Live

                ui.chunk.src = url;
                await new Promise(resolve => {
                    ui.chunk.onloadedmetadata = () => {
                        ui.chunk.play();
                        // Simulace posunu slideru
                        const anim = setInterval(() => {
                            if(curState !== STATE.TIMELAPSE) { clearInterval(anim); resolve(); return; }
                            const p = ui.chunk.currentTime / ui.chunk.duration;
                            ui.slider.value = (chunkId * CHUNK_SIZE) + (p * CHUNK_SIZE);
                        }, 200);
                    };
                    ui.chunk.onended = resolve;
                    ui.chunk.onerror = resolve;
                });
                chunkId++;
            }
        }

        // --- 7. HARDWARE & ANALÝZA ---
        async function loadDevices() {
            try {
                const d = await navigator.mediaDevices.enumerateDevices();
                const selV = document.getElementById('selVideo');
                const selA = document.getElementById('selAudio');
                selV.innerHTML=""; selA.innerHTML="";
                d.forEach(dev => {
                    const o = document.createElement('option');
                    o.value = dev.deviceId; o.text = dev.label || dev.kind;
                    if(dev.kind==='videoinput') selV.appendChild(o);
                    if(dev.kind==='audioinput') selA.appendChild(o);
                });
            } catch(e){}
        }

        async function initHardware() {
            try {
                const vId = camId || document.getElementById('selVideo').value;
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: vId && vId!=='Načítám...' ? { deviceId: {exact: vId} } : true,
                    audio: true
                });
                ui.live.srcObject = stream;
                
                // Audio
                const ac = new AudioContext();
                analyser = ac.createAnalyser();
                const src = ac.createMediaStreamSource(stream);
                src.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            } catch(e) { console.error(e); }
        }

        // HLAVNÍ SMYČKA (AVATAR + ANALÝZA)
        function renderLoop() {
            requestAnimationFrame(renderLoop);
            if (curState === STATE.OFF) return;

            // 1. ANALÝZA OBRAZU (každý 5. frame pro výkon)
            if (Date.now() % 200 < 20 && ui.live.readyState === 4) {
                ctxAnalysis.drawImage(ui.live, 0, 0, 64, 64);
                const frame = ctxAnalysis.getImageData(0,0,64,64).data;
                let r=0,g=0,b=0;
                for(let i=0; i<frame.length; i+=4) { r+=frame[i]; g+=frame[i+1]; b+=frame[i+2]; }
                const pixels = frame.length/4;
                currentStats.r = Math.round(r/pixels);
                currentStats.g = Math.round(g/pixels);
                currentStats.b = Math.round(b/pixels);
                currentStats.bri = Math.round((currentStats.r+currentStats.g+currentStats.b)/3);
                currentStats.hex = "#" + ((1 << 24) + (currentStats.r << 16) + (currentStats.g << 8) + currentStats.b).toString(16).slice(1);
                
                // Update UI Stats
                document.getElementById('fillBri').style.width = (currentStats.bri/2.55) + "%";
                document.getElementById('fillCol').style.backgroundColor = currentStats.hex;
            }

            // 2. ANALÝZA ZVUKU
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                const vol = dataArray[10]; // simple bass
                document.getElementById('fillVol').style.width = (vol/2.5) + "%";
            }

            // 3. AVATAR (Oči)
            // Sledování myši
            const cx = window.innerWidth/2;
            const cy = window.innerHeight/2;
            let tx = (mouseX - cx)/30; let ty = (mouseY - cy)/30;
            // Limit
            tx = Math.max(-15, Math.min(15, tx)); 
            ty = Math.max(-10, Math.min(10, ty));
            pupilX += (tx - pupilX)*0.1; 
            pupilY += (ty - pupilY)*0.1;

            ctxEyes.clearRect(0,0,1024,1024);
            // Maska
            const m = document.getElementById('sourceMask');
            const p = document.getElementById('sourcePupils');
            if(m && p) {
                ctxEyes.globalCompositeOperation = 'source-over';
                ctxEyes.drawImage(m, 0,0, 1024, 1024);
                ctxEyes.globalCompositeOperation = 'source-in';
                ctxEyes.drawImage(p, pupilX*10 + 256, pupilY*10, 1024, 1024); // Offset pupila
            }
        }
        
        // Myš
        document.addEventListener('mousemove', e => { mouseX=e.clientX; mouseY=e.clientY; });

        // Animace obličeje
        function triggerBlink() {
            if(curState===STATE.OFF) return;
            ui.headB.style.opacity = 0; ui.eyes.style.opacity = 0;
            ui.blink.src = "assets/blink_anim.webm"; 
            ui.blink.style.opacity = 1; ui.blink.play();
            ui.blink.onended = () => { 
                ui.blink.style.opacity=0; ui.headB.style.opacity=1; ui.eyes.style.opacity=1; 
            };
        }
        function triggerTongue() {
            if(curState===STATE.OFF) return;
            ui.headB.style.opacity = 0;
            ui.tongue.src = "assets/tongue_action.webm"; 
            ui.tongue.style.opacity = 1; ui.tongue.play();
            ui.tongue.onended = () => { 
                ui.tongue.style.opacity=0; ui.headB.style.opacity=1; 
            };
        }
        // Random mrkání
        setInterval(() => { if(Math.random()>0.7) triggerBlink(); }, 4000);


        // --- 8. NAHRÁVÁNÍ ---
        function startRecording() {
            if(!ui.live.srcObject) return;
            mediaRecorder = new MediaRecorder(ui.live.srcObject, { mimeType: 'video/webm; codecs=vp9' });
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
            mediaRecorder.onstop = uploadData;
            mediaRecorder.start();
            
            clearInterval(recInterval);
            recInterval = setInterval(() => {
                // Restartovat každou minutu
                if(mediaRecorder.state==='recording') mediaRecorder.stop();
            }, 60000);
        }

        function stopRecording() {
            if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop();
            clearInterval(recInterval);
        }

        async function uploadData() {
            if(chunks.length === 0 || curState !== STATE.LIVE || !octokit) return;
            
            ui.indicator.style.display = 'block';
            const blob = new Blob(chunks, {type:'video/webm'});
            chunks = [];
            
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const b64 = reader.result.split(',')[1];
                const fname = `mem_${Date.now()}.webm`;
                try {
                    await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
                        owner: REPO.owner, repo: REPO.name, path: `memories/${fname}`,
                        message: 'mem', content: b64
                    });
                    memories.push({filename: fname, timestamp: Date.now(), stats: {...currentStats}}); // Optimisticky přidat
                    ui.slider.max = memories.length;
                    if(curState===STATE.LIVE) ui.slider.value = memories.length;
                } catch(e) { console.error(e); }
                
                ui.indicator.style.display = 'none';
                if(curState===STATE.LIVE) mediaRecorder.start();
            };
        }

        async function loadDB() {
            try {
                const r = await fetch(`https://raw.githubusercontent.com/${REPO.owner}/${REPO.name}/main/memories/database.json?t=${Date.now()}`);
                memories = await r.json();
                ui.slider.max = memories.length;
            } catch(e){}
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('timeDisplay').innerText = now.toLocaleTimeString('cs-CZ');
            document.getElementById('dateDisplay').innerText = now.toLocaleDateString('cs-CZ');
        }

    </script>
</body>
</html>
