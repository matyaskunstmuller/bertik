name: Bertik Brain (Nuclear Option)

on:
  workflow_dispatch: # Pouze na manuální spuštění tlačítkem
  push:
    paths:
      - '.github/workflows/**' # Spustí se hned po uložení tohoto souboru

jobs:
  force-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout (Latest)
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # Stáhne všechno

    - name: Install FFmpeg
      run: sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Run Generator
      run: |
        cat <<EOF > generator.js
        const fs = require('fs');
        const { execSync } = require('child_process');
        const path = require('path');

        const MEM_DIR = 'memories';
        const CHUNK_DIR = 'memories/chunks';
        const DB_PATH = 'memories/database.json';
        const CHUNK_SIZE = 300; 

        if (!fs.existsSync(CHUNK_DIR)) fs.mkdirSync(CHUNK_DIR, { recursive: true });

        // 1. GENERUJEME NOVOU DATABÁZI OD NULY
        // Ignorujeme starý poškozený soubor a věříme jen tomu, co je ve složce
        const diskFiles = fs.readdirSync(MEM_DIR).filter(f => f.startsWith('mem_') && f.endsWith('.webm'));
        let db = [];
        
        console.log(\`Vidím \${diskFiles.length} souborů. Vytvářím novou DB.\`);

        diskFiles.forEach(f => {
             const ts = parseInt(f.split('_')[1]) || Date.now();
             db.push({
                 filename: f, 
                 timestamp: ts,
                 stats: { 
                    volume: 50, color: '#888888', motion: 50, brightness: 50, warmth: 50 
                 } 
             });
        });
        
        db.sort((a,b) => a.timestamp - b.timestamp);
        fs.writeFileSync(DB_PATH, JSON.stringify(db, null, 2));

        // 2. CHUNKY (Jen rychlá kontrola)
        const totalChunks = Math.floor(db.length / CHUNK_SIZE);
        for (let i = 0; i < totalChunks; i++) {
            const chunkName = \`chunk_\${i}.webm\`;
            const chunkPath = path.join(CHUNK_DIR, chunkName);
            if (!fs.existsSync(chunkPath)) {
                // ... (zde je stejný kód pro generování jako minule) ...
                // Pro stručnost vynechávám, protože hlavní je ta DB.
                // Pokud budeš chtít chunky, vložíme to tam zpět.
                // Teď prioritizujeme opravu DB.
            }
        }
        EOF
        node generator.js

    - name: Force Push
      run: |
        git config --global user.name 'Bertik Bot'
        git config --global user.email 'bot@bertik.ai'
        
        # Stáhneme úplně nejnovější verzi těsně před zápisem
        git pull origin main --strategy-option=theirs
        
        git add memories/database.json
        git commit -m "Force DB update" || echo "No changes"
        
        # Tady je změna: Pushujeme změny
        git push origin main
