name: Bertik Brain (Thumbnails & Chunks)

on:
  push:
    paths:
      - 'memories/**'
  workflow_dispatch:

jobs:
  optimize-system:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install FFmpeg
      run: sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Run Optimization Script
      run: |
        cat <<EOF > script.js
        const fs = require('fs');
        const { execSync } = require('child_process');
        const path = require('path');

        const MEM_DIR = 'memories';
        const CHUNK_DIR = 'memories/chunks';
        const THUMB_DIR = 'memories/thumbs';
        const DB_PATH = 'memories/database.json';
        const CHUNK_SIZE = 300; 

        if (!fs.existsSync(CHUNK_DIR)) fs.mkdirSync(CHUNK_DIR, { recursive: true });
        if (!fs.existsSync(THUMB_DIR)) fs.mkdirSync(THUMB_DIR, { recursive: true });

        // 1. NAČÍST VŠECHNY SOUBORY
        const files = fs.readdirSync(MEM_DIR).filter(f => f.startsWith('mem_') && f.endsWith('.webm'));
        console.log(\`Zpracovávám \${files.length} videí...\`);

        // 2. AKTUALIZACE DATABÁZE
        const db = files.map(filename => {
            const timestamp = parseInt(filename.split('_')[1]) || Date.now();
            return {
                filename: filename,
                timestamp: timestamp,
                // Náhodné statistiky (v budoucnu lze nahradit reálnou analýzou)
                stats: { volume: 50, color: '#888888', motion: 50, brightness: 50, warmth: 50 }
            };
        });
        db.sort((a,b) => a.timestamp - b.timestamp);
        fs.writeFileSync(DB_PATH, JSON.stringify(db, null, 2));

        // 3. GENERÁTOR NÁHLEDŮ (Každá 5. vzpomínka)
        console.log("Kontrola náhledů...");
        db.forEach((mem, index) => {
            if (index % 5 === 0) { // Jen každá pátá
                const thumbName = \`thumb_\${index}.jpg\`;
                const thumbPath = path.join(THUMB_DIR, thumbName);
                const vidPath = path.join(MEM_DIR, mem.filename);
                
                if (!fs.existsSync(thumbPath)) {
                    try {
                        // Vygenerovat malý obrázek (šířka 160px) pro rychlé načítání
                        execSync(\`ffmpeg -ss 0.0 -i "\${vidPath}" -vframes 1 -vf scale=160:-1 -q:v 10 "\${thumbPath}" -y\`, { stdio: 'ignore' });
                    } catch (e) {}
                }
            }
        });

        // 4. GENERÁTOR CHUNKŮ (Pro časosběr)
        const totalChunks = Math.floor(db.length / CHUNK_SIZE);
        for (let i = 0; i < totalChunks; i++) {
            const chunkName = \`chunk_\${i}.webm\`;
            const chunkPath = path.join(CHUNK_DIR, chunkName);

            if (!fs.existsSync(chunkPath)) {
                console.log(\`Generuji \${chunkName}...\`);
                const slice = db.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                const tempDir = \`temp_chunk_\${i}\`;
                if (fs.existsSync(tempDir)) fs.rmSync(tempDir, { recursive: true, force: true });
                fs.mkdirSync(tempDir);

                try {
                    let count = 0;
                    slice.forEach((mem, idx) => {
                        const vPath = path.join(MEM_DIR, mem.filename);
                        const iPath = path.join(tempDir, \`img_\${String(idx).padStart(3, '0')}.jpg\`);
                        try {
                            execSync(\`ffmpeg -ss 0.0 -i "\${vPath}" -vframes 1 -q:v 5 "\${iPath}" -y\`, { stdio: 'ignore' });
                            count++;
                        } catch(e){}
                    });

                    if(count > 0) {
                        // Generujeme plynulé video (30 FPS)
                        execSync(\`ffmpeg -framerate 30 -i \${tempDir}/img_%03d.jpg -c:v libvpx-vp9 -b:v 800k -speed 8 -pix_fmt yuv420p "\${chunkPath}"\`);
                    }
                } catch (e) { console.error(e); }
                try { fs.rmSync(tempDir, { recursive: true, force: true }); } catch(e) {}
            }
        }
        EOF
        
        node script.js

    - name: Deploy Changes
      run: |
        git config --global user.name 'Bertik Bot'
        git config --global user.email 'bot@bertik.ai'
        git add memories/database.json
        git add memories/thumbs/*.jpg
        git add memories/chunks/*.webm
        git commit -m "System Optimization" || echo "No changes"
        git pull --rebase origin main
        git push origin main
